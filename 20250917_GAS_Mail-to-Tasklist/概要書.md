## 1. 目的

Gmailに届く**会議要約メール**（Zoom／Google Meet／tl;dv／自分送信の議事録）をトリガーに、本文（必要時は添付）から**ネクストアクション**を抽出して**Googleのタスク**へ登録し、**Slack**へ通知する。

## 2. 対象インプット

* Gmail受信メール

  * Zoom要約（定型本文）
  * Google Meet要約（定型本文 or 添付）
  * tl;dv要約（定型本文 or 添付）
  * **自分が自分へ送る議事録**（CC/BCCにトリガー用アドレスを含める）
* 本文：プレーン／HTML
* 添付：PDF／TXT／Docx（必要時のみ抽出）

## 3. トリガー

* **自動**：Gmail受信トリガー（フィルタ／ラベル `todo-source/minutes` を条件）
* **手動**：自分議事録でトリガー用アドレスをCCに含める
* **ラベル駆動**：上記ラベル付メールを時間主導で巡回

## 4. 主要処理フロー

1. 対象メール取得 → 種別判定（Zoom／Meet／tl;dv／self）
2. 本文＋（必要時）添付をテキスト化
3. **Gemini API**で「実行可能な次アクション」をJSON抽出
4. **重複チェック**（会議ID×アクションハッシュ／代替キー）
5. **Google Tasks**へ登録（期限／メモ／リンク）
6. **Slack通知**（作成／スキップ数、各タスク概要）
7. **ログ**をスプレッドシートへ記録

## 5. タスク項目（登録仕様）

* `title`：命令形・40字以内
* `notes`：原文抜粋（≤120字）、会議リンク、Gmailリンク、簡易文脈
* `due`：本文に明示があればJSTで絶対日時化。なければ未設定（設定で既定可：例「翌営業日18:00」）
* 付帯メタ（notes内）：`source(zoom|meet|tldv|self)`, `meeting_id`, `message_id`

## 6. 重複判定

* 優先キー：`meeting_id`（URL/本文のID） + `action_hash`（正規化文＋期日をSHA-256）
* 代替：`(会議開始時刻±5分, 件名正規化, action_hash)`
* 判定済みキーはログ表に保持し再登録を回避

## 7. Slack通知（Incoming Webhook）

* 概要：`新規X件 / 重複Y件`
* 各タスク：`title / due / source / Gmailリンク / 会議リンク`

## 8. 設定（Script Properties）

* `GEMINI_API_KEY`
* `SLACK_WEBHOOK_URL`
* `GMAIL_QUERY`（例：`label:todo-source/minutes newer_than:7d`）
* `SELF_TRIGGER_ADDRESS`（自分議事録のCCアドレス）
* `TASKS_LIST_NAME`（例：`Meetings / Action Items`）
* `DUE_FALLBACK_RULE`（例：`NEXT_BUSINESS_DAY_18`）
* `TIMEZONE=Asia/Tokyo`

## 9. Gmailフィルタ／ラベル

* フィルタ例：From `no-reply@zoom.us`／`calendar-notification@google.com`／件名に`tl;dv`／`[minutes]`
* 付与ラベル：`todo-source/minutes`

## 10. エラーハンドリング（最小限）

* Gemini／API失敗：指数バックオフ3回→失敗はSlack警告＋メールへ`error/gemini`ラベル
* 添付抽出失敗：本文のみで続行＋Slack警告
* すべて結果はログ表へ（status：`new/dup/error`）

## 11. ログ（スプレッドシート）

* `timestamp, gmail_message_id, source, meeting_id, action_hash, status, task_id/url, notes`

## 12. セキュリティ／権限（必要最小）

* `Gmail.readonly`, `Tasks`, `Drive.file`（添付取扱時）, `Spreadsheets`
* APIキーはScript Properties管理（コード直書き禁止）

## 13. 受け入れ基準

1. Zoom要約1通→**3件**の新規タスク登録＋Slack通知
2. 同一会議のtl;dv要約→**重複登録なし**
3. 自分議事録（CCにトリガー）→処理実行・登録
4. 添付PDFのみでも最低1件抽出（本文なし時）
5. エラー時、Slackへ警告＋ログに`error`記録

## 14. 実装モジュール（GAS）

* `main.gs`（エントリ）／`gmail.gs`（検索・抽出・判定）
* `gemini.gs`（抽出プロンプト・API）
* `tasks.gs`（Google Tasks登録）
* `dedupe.gs`（キー生成・照会）
* `notify_slack.gs`（通知）
* `config.gs`／`log.gs`