# Gmail 受信メール処理ワークフロー（拡張版）設定手順

## 概要

このワークフローは企画書で定義された機能を実現し、Gmail 受信メールを自動で処理して以下を行います：

1. **OpenAI による要約処理** - メール内容を構造化された形式で要約
2. **Google Docs への追記** - 取引先別ドキュメントにメール単位で記録
3. **Google Sheets ダッシュボード更新** - 1 行形式でのサマリー更新
4. **期限・アクション検出** - 重要な日付やタスクの自動検出
5. **Google Calendar/Tasks への自動登録** - 期限がある場合の予定・タスク作成

## 設定手順

### 1. 前提条件

- n8n インスタンスが稼働していること
- 以下の Google サービスのアクセス権限が設定されていること：
  - Gmail API
  - Google Docs API
  - Google Sheets API
  - Google Calendar API
  - Google Tasks API
- OpenAI API キーが利用可能であること

### 2. 必要な認証情報

#### OpenAI

- OpenAI API キーを n8n の認証情報として設定

#### Google Services

- Google OAuth2 認証を設定
- 必要なスコープ：
  - `https://www.googleapis.com/auth/gmail.readonly`
  - `https://www.googleapis.com/auth/documents`
  - `https://www.googleapis.com/auth/spreadsheets`
  - `https://www.googleapis.com/auth/calendar`
  - `https://www.googleapis.com/auth/tasks`

### 3. Google Docs/Sheets の準備

#### Google Docs

1. 取引先別のドキュメントを作成
2. ワークフロー内の `YOUR_DOCUMENT_ID` をドキュメント ID に置換

#### Google Sheets

1. ダッシュボード用のスプレッドシートを作成
2. 「ダッシュボード」シートを作成
3. ヘッダー行を設定：
   - A: 相手先（会社名/担当者）
   - B: 最終更新日時
   - C: 最新要約（1 行）
   - D: ステータス（未対応／対応中／完了）
   - E: 次のアクション
   - F: 締切/日付
   - G: 詳細ドキュメントリンク
4. ワークフロー内の `YOUR_SPREADSHEET_ID` をスプレッドシート ID に置換

### 4. ワークフローの設定

1. n8n に `gmail_workflow.json` をインポート
2. 各ノードの設定を確認・調整：

#### Gmail Trigger

- 認証方法：OAuth2
- ポーリング間隔：必要に応じて調整（現在は 1 分ごと）

#### OpenAI 要約処理

- API キー認証を設定
- モデル：gpt-3.5-turbo または gpt-4
- 最大トークン数：500（必要に応じて調整）

#### Google Docs 追記

- ドキュメント URL：実際の Google Docs の URL に置換
- 認証：Google OAuth2

#### Google Sheets ダッシュボード更新

- ドキュメント ID：実際のスプレッドシート ID に置換
- シート名：「ダッシュボード」
- 認証：Google OAuth2

#### Google Calendar 予定追加

- カレンダー：primary（またはお使いのカレンダー ID）
- 認証：Google OAuth2

#### Google Tasks 追加

- タスクリスト：@default（またはお使いのタスクリスト ID）
- 認証：Google OAuth2

## ワークフローの動作

### 1. トリガー

- Gmail で新しいメールを受信すると自動実行

### 2. メール情報抽出

- 送信者、件名、本文、受信時刻を抽出
- 送信者名をクリーンアップ（< > 記号除去）

### 3. OpenAI 要約処理

- 構造化されたプロンプトでメール内容を要約
- 【要約】【次のアクション】【締切/日付】などの形式で出力

### 4. 並列処理

- Google Docs への追記
- Google Sheets ダッシュボード更新
- 期限・アクション検出
- 処理完了通知

### 5. 条件分岐処理

- 期限やアクションが検出された場合：
  - Google Calendar に予定追加
  - Google Tasks にタスク追加

## カスタマイズ可能な項目

### OpenAI プロンプト

- 要約形式の変更
- 抽出したい情報の追加
- 言語の変更

### 期限検出パターン

- 正規表現パターンの調整
- 検出キーワードの追加

### Google Calendar/Tasks 設定

- 予定の開始時刻（現在：翌日）
- 予定の長さ（現在：1 時間）
- タスクリストの指定

### Google Sheets 列構成

- 列の順序変更
- 追加情報の記録

## 注意点

1. **API 制限**

   - OpenAI API の利用料金に注意
   - Google APIs の制限に注意

2. **プライバシー**

   - メール内容が OpenAI に送信されることを理解
   - 機密情報の処理時は注意が必要

3. **エラーハンドリング**

   - 各ノードでエラーが発生した場合の処理を検討
   - 必要に応じてエラー処理ノードを追加

4. **パフォーマンス**
   - 大量のメール処理時の負荷を考慮
   - ポーリング間隔の調整

## トラブルシューティング

### よくある問題

1. **認証エラー**

   - OAuth2 の再認証
   - スコープの確認

2. **API エラー**

   - レート制限の確認
   - API キーの有効性確認

3. **データ形式エラー**
   - Expression の構文確認
   - データ構造の確認

### ログの確認

- n8n の実行ログを確認
- 各ノードの入出力データを確認
- エラーメッセージの詳細を確認

## 今後の拡張案

1. **取引先別の分岐処理**

   - 送信者ドメインによる処理分岐
   - 取引先別ドキュメントの自動選択

2. **スマート分類**

   - メール内容による重要度判定
   - 自動タグ付け

3. **通知機能**

   - Slack/Teams 通知
   - 重要メールのリアルタイム通知

4. **分析機能**
   - メール量の統計
   - 対応時間の追跡
